<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Management Demo</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    body { background-color: #f8f9fa; }
    .container { max-width: 850px; margin-top: 60px; }
    .card { border-radius: 1rem; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 2000; }
    #loadingOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.7);
      display: flex; align-items: center; justify-content: center;
      z-index: 3000; display: none;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-light bg-white shadow-sm fixed-top">
  <div class="container-fluid px-4">
    <span class="navbar-brand fw-bold">User Management System</span>
    <span class="navbar-text text-muted" id="navbarUser"></span>
  </div>
</nav>

<div id="loadingOverlay">
  <div class="spinner-border text-primary" role="status"></div>
</div>

<div class="toast-container"></div>

<div class="container">
  <div class="card shadow">
    <div class="card-body">
      <!-- Tabs -->
      <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login">Login</button></li>
        <li class="nav-item"><button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register">Register</button></li>
        <li class="nav-item"><button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile">Profile</button></li>
        <li class="nav-item"><button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes">Notes</button></li>
      </ul>

      <div class="tab-content">
        <!-- Login -->
        <div class="tab-pane fade show active" id="login">
          <form id="loginForm">
            <div class="mb-3"><label>Username</label><input type="text" class="form-control" id="loginUsername" required></div>
            <div class="mb-3"><label>Password</label><input type="password" class="form-control" id="loginPassword" required></div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
          </form>
        </div>

        <!-- Register -->
        <div class="tab-pane fade" id="register">
          <form id="registerForm">
            <div class="mb-2">
              <input type="text" class="form-control" id="regName" placeholder="Full Name" required>
            </div>
            <div class="mb-2">
              <input type="email" class="form-control" id="regEmail" placeholder="Email" required>
            </div>
            <div class="mb-2">
              <input type="text" class="form-control" id="regUsername" placeholder="Username" required>
            </div>
            <div class="mb-2">
              <input type="password" class="form-control" id="regPassword" placeholder="Password" required>
            </div>
            <div class="mb-2">
              <input type="date" class="form-control" id="regDob" placeholder="Date of Birth">
            </div>
            <div class="mb-2">
              <select class="form-control" id="regGender">
                <option value="">Select Gender</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="mb-2">
              <input type="text" class="form-control" id="regContact" placeholder="Mobile Number">
            </div>
            <div class="mb-2">
              <textarea class="form-control" id="regAddress" placeholder="Address"></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">Register</button>
          </form>
        </div>

        <!-- Profile -->
        <div class="tab-pane fade" id="profile">
          <h5 class="mb-3 text-center">Profile</h5>
          <form id="profileForm">
            <div class="row">
              <div class="col-md-6 mb-3"><input type="text" class="form-control" id="profName" placeholder="Full Name"></div>
              <div class="col-md-6 mb-3"><input type="email" class="form-control" id="profEmail" placeholder="Email" disabled></div>
              <div class="col-md-6 mb-3"><input type="text" class="form-control" id="profContact" placeholder="Contact No"></div>
              <div class="col-md-6 mb-3"><input type="text" class="form-control" id="profAddress" placeholder="Address"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Update Profile</button>
          </form>

          <div class="mt-4 d-grid gap-2">
            <button class="btn btn-outline-warning" id="changePasswordBtn">Change Password</button>
            <button class="btn btn-outline-secondary" id="logoutBtn">Logout</button>
          </div>
        </div>

        <!-- Notes -->
        <div class="tab-pane fade" id="notes">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Your Notes</h5>
            <button class="btn btn-sm btn-success" id="addNoteBtn">+ New Note</button>
          </div>
          <div id="notesList" class="list-group"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="noteForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Note</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteId">
        <div class="mb-3"><input type="text" id="noteTitle" class="form-control" placeholder="Title" required></div>
        <div class="mb-3"><textarea id="noteDesc" class="form-control" rows="4" placeholder="Description"></textarea></div>
        <div class="mb-3"><input type="file" id="noteAttachment" class="form-control"></div>
      </div>
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Save</button></div>
    </form>
  </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1">
  <div class="modal-dialog">
    <form id="passwordForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Change Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3"><input type="password" id="oldPassword" class="form-control" placeholder="Old Password" required></div>
        <div class="mb-3"><input type="password" id="newPassword" class="form-control" placeholder="New Password" required></div>
      </div>
      <div class="modal-footer"><button type="submit" class="btn btn-primary">Change</button></div>
    </form>
  </div>
</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
const API_BASE = '/api/user/';
let token = localStorage.getItem('token') || null;

// Check if user is logged in
if(token){
    try{
        const payload = JSON.parse(atob(token.split('.')[1]));
        const now = Math.floor(Date.now()/1000);
        if(payload.exp && payload.exp < now){
            // Token expired
            logoutUser();
        } else {
            // Token valid: disable login/register tabs
            $('#login-tab').addClass('disabled').attr('disabled', true).removeAttr('data-bs-toggle');
            $('#register-tab').addClass('disabled').attr('disabled', true).removeAttr('data-bs-toggle');

            // Optionally show Profile tab
            $('#profile-tab').click();
            loadProfile();
        }
    } catch(e){
        logoutUser();
    }
}

if(token){
    const payload = JSON.parse(atob(token.split('.')[1]));
    const name = localStorage.getItem('username') || payload.username || 'User';
    $('#navbarUser').text(name);
}

// ---------- Toast ----------
function showToast(msg, type='info') {
  const toastId = 't'+Date.now();
  const toast = $(`
    <div class="toast align-items-center text-white bg-${type} border-0" id="${toastId}">
      <div class="d-flex"><div class="toast-body">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>
    </div>`);
  $('.toast-container').append(toast);
  new bootstrap.Toast(toast[0]).show();
  toast.on('hidden.bs.toast', ()=>toast.remove());
}

// ---------- Loader ----------
function showLoader(show=true){ $('#loadingOverlay').toggle(show); }

// ---------- Logout ----------
function logoutUser() {
    token = null;
    localStorage.removeItem('token');

    // Clear navbar user display
    $('#navbarUser').text('');

    // Clear profile fields
    $('#profName').val('');
    $('#profEmail').val('');
    $('#profContact').val('');
    $('#profAddress').val('');

    // Clear notes list
    $('#notesList').empty();

    $('#login-tab, #register-tab').removeClass('disabled').attr('data-bs-toggle','tab').parent().show();

    // Switch back to login tab
    $('#login-tab').click();

    $('#noteForm')[0].reset();
    $('#noteId').val('');
    $('#passwordForm')[0].reset();
    
    showToast('Logged out successfully', 'info');
}
$('#logoutBtn').on('click', logoutUser);

// ---------- Global AJAX ----------
$.ajaxSetup({
  beforeSend: function(xhr){ if(token) xhr.setRequestHeader('Authorization','Bearer '+token); showLoader(true); },
  complete: function(){ showLoader(false); },
  statusCode: { 401: function(){ showToast('Session expired, please login','warning'); logoutUser(); } }
});

// ---------- Token Expiry Check ----------
if(token){
  try{
    const payload=JSON.parse(atob(token.split('.')[1]));
    const now=Math.floor(Date.now()/1000);
    if(payload.exp && payload.exp<now){ logoutUser(); }
  }catch(e){ logoutUser(); }
}

// ---------- LOGIN ----------
$('#loginForm').on('submit', e=>{
  e.preventDefault();
  $.post(API_BASE+'login/', {
    username:$('#loginUsername').val(),
    password:$('#loginPassword').val()
  }).done(res=>{
    token=res.data.token;
    localStorage.setItem('token',token);
    $('#navbarUser').text(res.data.name||res.data.username);
    showToast('Login successful','success');
    // Disable login/register tabs
    $('#login-tab').addClass('disabled').attr('disabled', true).removeAttr('data-bs-toggle');
    $('#register-tab').addClass('disabled').attr('disabled', true).removeAttr('data-bs-toggle');
    $('#profile-tab').click();
    loadProfile();
  }).fail(()=>showToast('Invalid credentials','danger'));
});

// ---------- REGISTER ----------
$('#registerForm').submit(function(e){
    e.preventDefault();
    $.ajax({
        url: API_BASE + 'register/',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            name: $('#regName').val(),
            email: $('#regEmail').val(),
            username: $('#regUsername').val(),
            password: $('#regPassword').val(),
            dob: $('#regDob').val(),
            gender: $('#regGender').val(),
            contact_no: $('#regContact').val(),
            address: $('#regAddress').val(),
        }),
        success: function(res){
            showToast('Registered successfully! Please login.', 'success');
            $('#login-tab').click();
            $('#registerForm')[0].reset();
        },
        error: function(xhr){
            showToast('Registration failed: ' + (xhr.responseJSON?.message || 'Unknown error'), 'danger');
        }
    });
});

// ---------- PROFILE ----------
function loadProfile(){
  if(!token) return;
  $.ajax({
    url:API_BASE+'profile/view/',
    success:res=>{
      const p=res.data;
      $('#profName').val(p.name);
      $('#profEmail').val(p.email);
      $('#profContact').val(p.contact_no);
      $('#profAddress').val(p.address);
      $('#navbarUser').text(p.name||p.email);
    },
    error:()=>showToast('Failed to load profile','danger')
  });
}
$('#profileForm').on('submit', e=>{
  e.preventDefault();
  $.ajax({
    url:API_BASE+'profile/update/',
    type:'PUT',
    data:{
      name:$('#profName').val(),
      contact_no:$('#profContact').val(),
      address:$('#profAddress').val()
    },
    success:()=>showToast('Profile updated','success'),
    error:()=>showToast('Update failed','danger')
  });
});

// ---------- PASSWORD ----------
$('#changePasswordBtn').on('click', ()=>$('#passwordModal').modal('show'));
$('#passwordForm').on('submit', e=>{
  e.preventDefault();
  $.ajax({
    url:API_BASE+'changepassword/',
    type:'PUT',
    data:{
      old_password:$('#oldPassword').val(),
      new_password:$('#newPassword').val()
    },
    success:()=>{
      showToast('Password changed','success');
      $('#passwordModal').modal('hide');
      $('#oldPassword,#newPassword').val('');
    },
    error:()=>showToast('Change failed','danger')
  });
});

// ---------- NOTES ----------
function loadNotes(){
  $.ajax({
    url:API_BASE+'notes/list',
    success:res=>{
      const notes=res.data||[];
      $('#notesList').empty();
      if(notes.length===0){ $('#notesList').append('<div class="text-muted text-center py-3">No notes yet</div>'); return; }
      notes.forEach(n=>{
        $('#notesList').append(`
          <div class="list-group-item d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${n.title}</div>
              <small>${n.description||''}</small>
            </div>
            <div>
              <button class="btn btn-sm btn-outline-primary me-1 editNote" data-id="${n.id}">Edit</button>
              <button class="btn btn-sm btn-outline-danger deleteNote" data-id="${n.id}">Del</button>
            </div>
          </div>`);
      });
    },
    error:()=>showToast('Failed to load notes','danger')
  });
}

$('#addNoteBtn').on('click', ()=>{
  $('#noteForm')[0].reset();
  $('#noteId').val('');
  $('#noteModal').modal('show');
});

$('#notesList').on('click','.editNote',function(){
  const id=$(this).data('id');
  $.ajax({url:API_BASE+`notes/list`,success:res=>{
    const note=res.data.find(x=>x.id===id);
    if(!note)return;
    $('#noteId').val(note.id);
    $('#noteTitle').val(note.title);
    $('#noteDesc').val(note.description);
    $('#noteModal').modal('show');
  }});
});

$('#notesList').on('click','.deleteNote',function(){
  const id=$(this).data('id');
  $.ajax({
    url:API_BASE+`notes/${id}/delete`,
    type:'DELETE',
    success:()=>{showToast('Note deleted','success');loadNotes();},
    error:()=>showToast('Delete failed','danger')
  });
});

$('#noteForm').on('submit', e=>{
  e.preventDefault();
  const id=$('#noteId').val();
  const formData=new FormData();
  formData.append('title',$('#noteTitle').val());
  formData.append('description',$('#noteDesc').val());
  const file=$('#noteAttachment')[0].files[0];
  if(file) formData.append('attachment',file);

  $.ajax({
    url:API_BASE+(id?`notes/${id}/update`:'notes/create'),
    type:id?'PUT':'POST',
    processData:false,contentType:false,
    data:formData,
    success:()=>{
      $('#noteModal').modal('hide');
      showToast(id?'Note updated':'Note created','success');
      loadNotes();
    },
    error:()=>showToast('Save failed','danger')
  });
});

$('#profile-tab').on('click', loadProfile);
$('#notes-tab').on('click', loadNotes);
</script>
</body>
</html>
